<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Studio Manager</title>
<style>
  :root{--bg:#0a0a0e;--panel:#111118;--edge:#191926;--ink:#e9e9ee;--gold:#ffbf3c;--gold2:#ffd56f;--ok:#22d68f;--warn:#ffd25f;--bad:#ff5b6a;--accent:#67d4ff}
  *{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 700px at -10% -10%,#17172a 0%,#0a0a0e 45%),#0a0a0e;color:var(--ink);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  .wrap{max-width:1200px;margin:32px auto;padding:16px}
  .h1{display:flex;align-items:center;gap:10px;margin:0 0 12px 0}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a2a3a;background:linear-gradient(180deg,#171725,#111118);font-size:12px}
  .gold{background:linear-gradient(180deg,var(--gold),var(--gold2));color:#171410;border:none}
  .grid{display:grid;gap:14px}
  .two{grid-template-columns:1.2fr .8fr}
  .card{background:linear-gradient(180deg,#13131d,#0f0f15);border:1px solid #202032;border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select,textarea{width:100%;background:#0c0c12;color:var(--ink);border:1px solid #27273a;border-radius:10px;padding:10px 12px}
  button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-gold{background:linear-gradient(180deg,var(--gold),var(--gold2));color:#111}
  .btn-ghost{background:#171723;color:#e8e8f3;border:1px solid #2a2a39}
  .btn-danger{background:linear-gradient(180deg,#ff6b7b,#ff5b6a);color:#fff}
  .btn-ok{background:linear-gradient(180deg,#2fe6a2,#22d68f);color:#072018}
  details{border:1px solid #24243a;border-radius:14px;background:#101018}
  summary{list-style:none;padding:14px;cursor:pointer;font-weight:800}
  summary::-webkit-details-marker{display:none}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
  .list{display:grid;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;background:#0c0c13;border:1px solid #24243a;border-radius:12px;padding:10px 12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#666;margin-right:8px;display:inline-block}
  .ok{background:var(--ok)} .warn{background:var(--warn)} .bad{background:var(--bad)}
  .bar{height:10px;background:#141427;border-radius:999px;overflow:hidden}
  .fill{height:100%;width:0;background:linear-gradient(90deg,#ffd36e,#ffbf3c)}
  .right{display:flex;gap:8px;align-items:center}
  a{color:var(--accent);text-decoration:none}
  .muted{opacity:.75}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">
    <h1 style="margin:0">Studio Manager</h1>
    <span class="pill gold">Dark • Gold</span>
    <span class="pill">Channels</span>
    <span class="pill">Pipelines</span>
  </div>

  <!-- API & Config -->
  <details class="card" open>
    <summary>🔑 API & Config</summary>
    <div class="row">
      <input id="openrouter" placeholder="OpenRouter API (sk-or-…)" />
      <input id="replicate" placeholder="Replicate Token (r8_…)" />
    </div>
    <div class="row">
      <input id="sheetId" placeholder="Google Sheet ID" value="1fkNcw3Av6DYxEG57WPbw54Tl-NyJQC5BMjyafCb547k"/>
      <input id="sheetName" placeholder="Sheet name" value="Videos"/>
    </div>
    <div class="row">
      <button class="btn-ok" id="saveCfg">💾 Save</button>
      <button class="btn-ghost" id="testFns">🧪 Ping Functions</button>
      <span class="pill" id="cfgNote">Unsaved</span>
    </div>
  </details>

  <div class="grid two">
    <!-- Channels -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Studio Manager</h3>
      <div class="row">
        <button class="btn-ghost" id="btnRefresh">🔄 Refresh Channels</button>
        <button class="btn-gold" id="btnRunSelected">🚀 Run Selected</button>
        <button class="btn-ghost" id="btnTrends">🌍 Fetch Trends</button>
        <button class="btn-ghost" id="btnHealth">🧩 Check Resources</button>
        <button class="btn-ghost" id="btnAnalytics">📊 Show Analytics</button>
        <button class="btn-ghost" id="btnAuthYT">🎥 Authorize YouTube</button>
      </div>

      <details style="margin-top:10px">
        <summary>➕ Add Channel</summary>
        <div class="row" style="margin:10px 0">
          <input id="chName" placeholder="Channel Name"/>
          <input id="chTopic" placeholder="Topic / Niche"/>
          <button class="btn-ok" id="btnAddChannel">Add</button>
        </div>
      </details>

      <div id="channels" class="list" style="margin-top:12px">
        <div class="muted">Loading channels…</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">AI Content Creator Manager</h3>
      <div class="row">
        <button class="btn-gold" id="qaScript">📝 Generate Script</button>
        <button class="btn-ok" id="qaVideo">🎬 Create Video</button>
        <button class="btn-ghost" id="qaUpload">⬆️ Upload to YouTube</button>
        <button class="btn-ghost" id="qaOptimize">🤖 AI Optimize</button>
        <button class="btn-danger" id="qaClear">📜 Clear Logs</button>
      </div>

      <details style="margin-top:10px">
        <summary>🧰 Script/Image Settings</summary>
        <div class="row" style="margin:10px 0">
          <select id="genre">
            <option>Horror Psicológico</option>
            <option>Crimen Real</option>
            <option>Misterios</option>
            <option>Suspenso</option>
            <option>Paranormal</option>
          </select>
          <select id="lang">
            <option value="es">Español</option>
            <option value="en">Inglés</option>
          </select>
          <input id="words" type="number" min="800" max="4000" step="100" value="2500"/>
        </div>
        <div class="row">
          <input id="idea" placeholder="Idea (leave blank to auto)"/>
          <input id="imgPrompt" placeholder="Image prompt (auto if blank)"/>
        </div>
      </details>

      <div style="margin-top:12px">
        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="muted" id="prog">Idle.</div>
      </div>
    </div>
  </div>

  <!-- Trends & Resources & Analytics -->
  <details class="card" style="margin-top:14px">
    <summary>🔥 Global & YouTube Trends</summary>
    <div id="trends" class="mono muted">Press “Fetch Trends”.</div>
  </details>

  <details class="card">
    <summary>🧠 Resource Monitor</summary>
    <div class="list" id="health">
      <div class="item"><span><span class="dot" id="dotFree"></span>Freesound</span><span class="muted" id="freeMsg">—</span></div>
      <div class="item"><span><span class="dot" id="dotRep"></span>Replicate</span><span class="muted" id="repMsg">—</span></div>
      <div class="item"><span><span class="dot" id="dotTts"></span>TTS Engine</span><span class="muted" id="ttsMsg">—</span></div>
      <div class="item"><span><span class="dot" id="dotSheets"></span>Google Sheets</span><span class="muted" id="shtMsg">—</span></div>
    </div>
  </details>

  <details class="card" open>
    <summary>📜 System Log</summary>
    <div id="log" class="mono muted">Ready.</div>
  </details>
</div>

<script>
const $ = s=>document.querySelector(s);
const now = ()=> new Date().toLocaleTimeString();
const log = (m)=> { const el = $("#log"); el.innerHTML += `<br>[${now()}] ${m}`; el.scrollTop = el.scrollHeight; };
const setDot = (id,cls,msg)=>{ const d=$(id); d.classList.remove("ok","warn","bad"); d.classList.add(cls); if(msg) $(id.replace('dot','').toLowerCase()+'Msg')?.textContent=msg; };
const progress = (p,t)=>{ $("#fill").style.width = `${p}%`; $("#prog").textContent = t||""; };

function saveCfg(){
  const cfg = {
    openrouter: $("#openrouter").value.trim(),
    replicate: $("#replicate").value.trim(),
    sheetId: $("#sheetId").value.trim(),
    sheetName: $("#sheetName").value.trim()
  };
  localStorage.setItem("studioCfg", JSON.stringify(cfg));
  $("#cfgNote").textContent = "Saved";
  $("#cfgNote").classList.add("gold");
  log("Config saved.");
  return cfg;
}
function loadCfg(){
  const raw = localStorage.getItem("studioCfg"); if(!raw) return;
  try{ const c=JSON.parse(raw);
    $("#openrouter").value = c.openrouter||"";
    $("#replicate").value = c.replicate||"";
    $("#sheetId").value   = c.sheetId||"";
    $("#sheetName").value = c.sheetName||"";
    $("#cfgNote").textContent = "Loaded"; $("#cfgNote").classList.add("gold");
  }catch{}
}
$("#saveCfg").onclick = saveCfg;

async function post(url, body){
  const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body||{}) });
  if(!r.ok){
    let msg = `HTTP ${r.status}`;
    try{ const j = await r.json(); if(j.error) msg = j.error; }catch{}
    throw new Error(msg);
  }
  return r.json();
}

// Ping Functions
$("#testFns").onclick = async ()=>{
  try{
    const res = await fetch("/.netlify/functions/hello");
    log(res.ok ? "Functions online ✅" : "Functions offline ❌");
  }catch{ log("Functions offline ❌"); }
};

// Refresh Channels (READ via POST to sheets-read)
async function refreshChannels(){
  const { sheetId, sheetName } = saveCfg();
  log("Fetching channels from Google Sheets…");
  try{
    const data = await post("/.netlify/functions/sheets-read",{ sheetId, sheetName });
    const rows = data.rows||[];
    if(rows.length === 0){ $("#channels").innerHTML = `<div class="muted">No channels found in “${sheetName}”.</div>`; return; }
    $("#channels").innerHTML = rows.map((r,i)=>`
      <div class="item">
        <div><strong>${r.Channel||r.channel||r.Name||r.name||('Channel '+(i+1))}</strong>
        <span class="muted"> • ${r.Topic||r.topic||r.Niche||r.niche||'—'}</span></div>
        <div class="right">
          <button class="btn-ghost" onclick="runOne(${i})">▶ Run</button>
        </div>
      </div>
    `).join("");
    setDot("#dotSheets","ok","OK");
    log(`Loaded ${rows.length} channels ✅`);
  }catch(e){
    setDot("#dotSheets","bad","Error");
    $("#channels").innerHTML = `<div class="muted">❌ ${e.message}</div>`;
    log(`Failed to load channels: ${e.message}`);
  }
}
window.runOne = async (i)=>{ log(`Run channel #${i+1} (stub)`); };

// Add Channel (append row) — uses your existing google-sheets function (POST/write)
$("#btnAddChannel").onclick = async ()=>{
  const cfg = saveCfg();
  const name = $("#chName").value.trim();
  const topic = $("#chTopic").value.trim();
  if(!name){ alert("Channel name required"); return; }
  try{
    log("Adding channel…");
    const res = await post("/.netlify/functions/google-sheets",{
      sheetId: cfg.sheetId, sheetName: cfg.sheetName,
      row: { Channel: name, Topic: topic, CreatedAt: new Date().toISOString() }
    });
    if(res.ok){ log("Channel added ✅"); refreshChannels(); }
    else throw new Error(res.error||"Write error");
  }catch(e){ log("Add channel ❌ " + e.message); }
};

// Buttons wiring
$("#btnRefresh").onclick = refreshChannels;
$("#btnHealth").onclick = async ()=>{
  log("Checking resource health…");
  try{
    const rep = await post("/.netlify/functions/validate-replicate",{});
    setDot("#dotRep","ok","OK");
  }catch{ setDot("#dotRep","bad","Fail"); }
  // You can add more pings (coqui-tts, freesound-search) if desired
  setDot("#dotFree","warn","Ping not implemented");
  setDot("#dotTts","warn","Ping not implemented");
  log("Resource check complete.");
};
$("#btnTrends").onclick = async ()=>{
  log("Fetching trends…");
  try{
    const res = await post("/.netlify/functions/ambient-plan",{ topic: "global+youtube" });
    $("#trends").textContent = JSON.stringify(res, null, 2);
    log("Trends fetched ✅");
  }catch(e){ log("Trends ❌ " + e.message); }
};
$("#btnAnalytics").onclick = ()=> log("Analytics panel — TODO");
$("#btnAuthYT").onclick = ()=> log("YouTube OAuth placeholder — TODO");
$("#qaClear").onclick = ()=> $("#log").innerHTML = "Cleared.";

// Quick pipeline: Script → Image → Video
$("#qaScript").onclick = async ()=>{
  const cfg = saveCfg();
  if(!cfg.openrouter){ alert("OpenRouter key required"); return; }
  try{
    progress(10,"Generating idea…");
    const idea = $("#idea").value.trim();
    if(!idea){
      const ideaRes = await post("/.netlify/functions/generate-idea",{
        apiKey: cfg.openrouter, genre: $("#genre").value, language: $("#lang").value, generateTitle: true
      });
      $("#idea").value = ideaRes.idea || "";
    }
    progress(40,"Generating script…");
    const scr = await post("/.netlify/functions/generate-script",{
      apiKey: cfg.openrouter, genre: $("#genre").value, language: $("#lang").value,
      wordCount: parseInt($("#words").value,10)||2500, idea: $("#idea").value.trim(), humanization: true
    });
    localStorage.setItem("lastScript", scr.script||"");
    progress(70,"Script ready ✅");
    log("Script generated ✅");
  }catch(e){ progress(0,""); log("Script ❌ " + e.message); }
};

$("#qaVideo").onclick = async ()=>{
  const cfg = saveCfg();
  if(!cfg.replicate){ alert("Replicate token required"); return; }
  try{
    progress(75,"Generating key art…");
    const imgRes = await post("/.netlify/functions/generate-image",{
      replicateKey: cfg.replicate,
      prompt: $("#imgPrompt").value.trim() || `Key art ${$("#genre").value}, cinematic, dramatic lighting`,
      genre: $("#genre").value
    });
    progress(90,"Creating video…");
    const video = await post("/.netlify/functions/generate-video",{
      script: localStorage.getItem("lastScript") || "Short intro…",
      imageUrl: imgRes.imageUrl,
      genre: $("#genre").value,
      videoTitle: `Auto ${new Date().toLocaleDateString()}`,
      voice: "female_01"
    });
    log(video.videoUrl ? `Video ✅ ${video.videoUrl}` : "Video ✅ (no URL)");
    progress(100,"Done.");
  }catch(e){ progress(0,""); log("Video ❌ " + e.message); }
};

loadCfg();
refreshChannels();
</script>
</body>
</html>
